<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Easily convert JSON channel lists into .M3U files.">
  <title>JSON to .M3U Converter</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/css/style.css" rel="stylesheet">
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    /* Use the main theme rules in ../assets/css/style.css via html[data-bs-theme]
       Keep a few small local helpers */
    .fixed-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
    }
  </style>
</head>
<body class="bg-light">
  <main class="container py-5">
    <div class="card shadow-lg p-4 mx-auto" style="max-width: 720px;">
      <header class="text-center mb-4">
        <h1 class="fw-bold text-primary mb-2">ğŸ§¾ JSON to .M3U Converter</h1>
        <p class="text-muted">
          Works with JSON files that follow the 
          <a href="https://github.com/Alplox/json-teles" target="_blank" rel="noopener" class="link-primary">json-tv</a> 
          format or compatible variations. If your file does not follow that format, conversion may fail.
        </p>
      </header>

      <!-- Default list -->
      <section class="mb-3">
        <button id="loadDefaultBtn" class="btn btn-secondary w-100">
          ğŸ“‚ Load Default List
        </button>
      </section>

      <!-- Advanced options -->
      <button id="toggleOptionsBtn" type="button" class="btn btn-outline-primary w-100 mb-3">
        Advanced Options â–¼
      </button>
      <div id="advancedOptions" class="d-none">
        <!-- From URL -->
        <div class="mb-3">
          <label for="urlInput" class="form-label fw-semibold">ğŸŒ Paste JSON URL (optional):</label>
          <input type="text" id="urlInput" class="form-control" placeholder="https://raw.githubusercontent.com/.../channels.json">
          <button id="loadFromUrlBtn" class="btn btn-primary mt-2 w-100">Load from URL</button>
        </div>

        <!-- From file -->
        <div class="mb-3">
          <label for="fileInput" class="form-label fw-semibold">ğŸ“ Upload JSON File:</label>
          <input type="file" id="fileInput" class="form-control" accept=".json">
        </div>

        <!-- Paste JSON -->
        <div class="mb-3">
          <label for="jsonInput" class="form-label fw-semibold">ğŸ“ Or paste your JSON here:</label>
          <textarea id="jsonInput" rows="8" class="form-control" placeholder="{ ... }"></textarea>
          <div id="jsonStatus" class="mt-2 small"></div>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="d-grid gap-2 mb-3">
        <button id="convertBtn" class="btn btn-primary">Convert to .M3U</button>
        <div class="d-flex gap-2">
          <button id="copyBtn" class="btn btn-success d-none flex-fill">ğŸ“‹ Copy Result</button>
          <a id="downloadBtn" download="list.m3u" class="btn btn-warning d-none flex-fill text-dark fw-bold">â¬‡ï¸ Download Result</a>
        </div>
      </div>

      <!-- Channel status -->
      <section id="channelStatus" class="mb-3 fw-semibold text-success"></section>

      <!-- Output -->
      <div class="mb-3">
        <label for="output" class="form-label fw-semibold">ğŸ“„ Result:</label>
        <textarea id="output" rows="8" readonly class="form-control"></textarea>
      </div>

      <!-- Spinner -->
      <div id="spinner" class="text-center my-3 d-none">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="text-muted mt-2">Loading JSON file...</div>
      </div>
    </div>

    <!-- Dark mode toggle -->
    <button id="darkmodeToggle" class="btn btn-outline-primary fixed-toggle">ğŸŒ™ Dark Mode</button>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Original: https://raw.githubusercontent.com/Alplox/json-teles/refs/heads/main/canales.json
      // Updated: https://raw.githubusercontent.com/interneto/tv-multiview/refs/heads/main/json-tv/tv-channels.json
      const defaultURL = "https://raw.githubusercontent.com/interneto/tv-multiview/refs/heads/main/json-tv/tv-channels.json";
      const fileInput = document.getElementById('fileInput');
      const loadDefaultBtn = document.getElementById('loadDefaultBtn');
      const loadFromUrlBtn = document.getElementById('loadFromUrlBtn');
      const convertBtn = document.getElementById('convertBtn');
      const copyBtn = document.getElementById('copyBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const urlInput = document.getElementById('urlInput');
      const jsonInput = document.getElementById('jsonInput');
      const jsonStatus = document.getElementById('jsonStatus');
      const spinner = document.getElementById('spinner');
      const channelStatus = document.getElementById('channelStatus');
      const output = document.getElementById('output');
      const darkmodeToggle = document.getElementById('darkmodeToggle');
      const toggleOptionsBtn = document.getElementById('toggleOptionsBtn');
      const advancedOptions = document.getElementById('advancedOptions');

      // File input
      fileInput?.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          jsonInput.value = ev.target.result;
          // Validate immediately after loading file
          validateJson();
        };
        reader.readAsText(file);
      });

      // Load default JSON
      loadDefaultBtn?.addEventListener('click', () => loadJSONFrom(defaultURL, true));

      // Load from URL
      loadFromUrlBtn?.addEventListener('click', () => {
        const url = urlInput.value.trim();
        if (!url) return alert("âš ï¸ Please enter a valid URL.");
        loadJSONFrom(url);
      });

      // Copy output
      copyBtn?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(output.value);
          alert('ğŸ“‹ Copied to clipboard!');
        } catch {
          output.removeAttribute('readonly');
          output.select();
          document.execCommand('copy');
          output.setAttribute('readonly', '');
          alert('ğŸ“‹ Copied to clipboard!');
        }
      });

      // Convert JSON to M3U
      convertBtn?.addEventListener('click', () => convert());

      // JSON validation
      function validateJson() {
        if (!jsonInput) return;
        try {
          JSON.parse(jsonInput.value);
          jsonStatus.textContent = 'âœ… Valid JSON';
          jsonStatus.className = 'text-success small';
          return true;
        } catch {
          jsonStatus.textContent = 'âŒ Invalid JSON';
          jsonStatus.className = 'text-danger small';
          return false;
        }
      }

      jsonInput?.addEventListener('input', validateJson);

      // Dark mode toggle
      function setDarkMode(enabled) {
        document.documentElement.setAttribute('data-bs-theme', enabled ? 'dark' : 'light');
        darkmodeToggle.textContent = enabled ? 'â˜€ï¸ Light Mode' : 'ğŸŒ™ Dark Mode';
      }
      // Initialize from localStorage, default to light
      setDarkMode(localStorage.getItem('darkmode') === 'true');
      darkmodeToggle?.addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-bs-theme') !== 'dark';
        setDarkMode(isDark);
        localStorage.setItem('darkmode', isDark);
      });

      // Advanced options toggle
      toggleOptionsBtn?.addEventListener('click', () => {
        advancedOptions.classList.toggle('d-none');
        toggleOptionsBtn.textContent = advancedOptions.classList.contains('d-none')
          ? 'Advanced Options â–¼' : 'Hide Advanced Options â–²';
      });

      // Helpers
      async function loadJSONFrom(url, showAlert = false) {
        spinner.classList.remove('d-none');
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error();
          const data = await res.text();


          jsonInput.value = data;
          // Validate JSON directly
          validateJson();

          if (showAlert) alert("âœ… Default list loaded successfully");
        } catch {
          alert("âŒ Could not load JSON from URL.");
        } finally {
          spinner.classList.add('d-none');
        }
      }

      function convert() {
        let channels;
        try {
          channels = JSON.parse(jsonInput.value);
        } catch {
          alert("âŒ Invalid JSON");
          return;
        }

        let m3u = '#EXTM3U\n';
        let totalChannels = 0, channelsWithM3u8 = 0, totalEntries = 0, duplicateChannels = 0, duplicateNames = [];

        for (const key in channels) {
          const ch = channels[key];
          totalChannels++;
          const name = ch.name || key;
          const logo = ch.logo || '';
          const category = ch.category || 'General';
          const country = ch.country ? ch.country.toUpperCase() : 'INTL';
          const urls = ch.signals?.m3u8_url || [];
          if (urls.length === 0) continue;
          channelsWithM3u8++;
          if (urls.length > 1) {
            duplicateChannels++;
            duplicateNames.push(name);
          }
          urls.forEach((url, i) => {
            const suffix = urls.length > 1 ? ` (${i+1})` : '';
            const visibleName = `${name}${suffix} [${country}]`;
            m3u += `#EXTINF:-1 tvg-name="${name}" tvg-logo="${logo}" group-title="${category}", ${visibleName}\n${url}\n`;
            totalEntries++;
          });
        }

        if (totalEntries === 0) {
          channelStatus.innerText = "âš ï¸ No valid .m3u8 signals found in the JSON.";
          channelStatus.className = "text-danger fw-semibold";
        } else {
          let msg = `âœ… JSON contains <strong>${totalChannels}</strong> channels.<br>
            ğŸ“¡ <strong>${channelsWithM3u8}</strong> have <code>.m3u8</code> signals.<br>
            ğŸ¬ Generated <strong>${totalEntries}</strong> total <code>.m3u8</code> entries.`;
          if (duplicateChannels > 0) {
            msg += `<br>ğŸ” <strong>${duplicateChannels}</strong> channels had multiple signals.`;
            const preview = duplicateNames.slice(0,5).join(', ');
            msg += `<br>ğŸ“‹ Multiple-signal channels: <em>${preview}${duplicateNames.length > 5 ? ', ...' : ''}</em>`;
          }
          channelStatus.innerHTML = msg;
          channelStatus.className = "text-success fw-semibold";
        }

        output.value = m3u;
        const blob = new Blob([m3u], { type: 'audio/x-mpegurl' });
        downloadBtn.href = URL.createObjectURL(blob);
        downloadBtn.classList.remove('d-none');
        copyBtn.classList.remove('d-none');
      }
    });
  </script>
</body>
</html>
